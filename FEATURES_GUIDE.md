# 音楽プレイヤー機能ガイド

## 実装済み機能

### 1. バックグラウンド再生（Media Session API）✅

#### 機能概要
- ブラウザやタブを閉じても再生が継続
- OSの通知センターやロック画面から操作可能
- システムレベルでの音楽コントロール

#### 実装内容
- **メタデータ同期**: 曲名、アーティスト名、アルバムアートをシステムに送信
- **再生状態の同期**: 再生/一時停止状態をリアルタイムで更新
- **アクションハンドラー**:
  - ✅ 再生/一時停止
  - ✅ 前の曲へ
  - ✅ 次の曲へ
  - ✅ シーク（早送り/巻き戻し）
  - ✅ 特定位置へのジャンプ

#### 使い方
1. 曲を再生する
2. ブラウザを最小化またはタブを切り替える
3. ロック画面や通知センターから操作

#### 対応ブラウザ
- Chrome/Edge: 完全対応
- Firefox: 部分対応
- Safari: iOS/macOS で対応

---

### 2. プレイリスト機能✅

#### 機能概要
- 自由にプレイリストを作成・削除
- 曲をプレイリストに追加
- プレイリストごとに曲を管理

#### 実装内容

##### プレイリスト作成
1. サイドバーの「Playlists」セクションにある「+」ボタンをクリック
2. プレイリスト名を入力
3. 「作成」ボタンをクリック

##### プレイリストに曲を追加
1. 曲リストの各行にある「...」メニューをクリック
2. 「プレイリストに追加」を選択
3. 追加先のプレイリストを選択

##### プレイリストの削除
1. サイドバーのプレイリスト名にマウスをホバー
2. 表示される「ゴミ箱」アイコンをクリック
3. 確認ダイアログで「OK」をクリック

##### プレイリストの表示
- サイドバーのプレイリスト名をクリックすると、そのプレイリストの曲一覧が表示されます

#### データベース構造
```
Playlist (プレイリスト)
├── id: プレイリストID
├── name: プレイリスト名
├── description: 説明（オプション）
└── tracks: 曲のリスト

PlaylistTrack (中間テーブル)
├── playlistId: プレイリストID
├── trackId: 曲ID
└── order: 並び順
```

---

### 3. 前の曲/次の曲機能✅

#### 機能概要
- プレイリスト内で前後の曲に移動
- キーボードショートカット対応
- ロック画面からも操作可能

#### 使い方

##### プレイヤーバーから
- 「⏮」ボタン: 前の曲へ
- 「⏭」ボタン: 次の曲へ

##### キーボードショートカット
- `←` (左矢印): 前の曲へ
- `→` (右矢印): 次の曲へ

##### ロック画面/通知センターから
- 「Previous」ボタン: 前の曲へ
- 「Next」ボタン: 次の曲へ

#### 動作
- 現在のプレイリスト内で前後の曲に移動
- 最初の曲で「前へ」を押しても移動しない
- 最後の曲で「次へ」を押しても移動しない

---

### 4. 既存バグの修正✅

#### 修正内容

##### 再生時間の表示
- ✅ Duration（秒数）が正しく表示される
- ✅ 再生バーが正常に動作
- ✅ アップロード時にメタデータを取得

##### レイアウトの改善
- ✅ 曲リストと再生バーの間の空白を解消
- ✅ 画面全体を有効活用
- ✅ 再生バーを画面下部に固定
- ✅ リストエリアのみがスクロール

##### メタデータの更新
- ✅ 既存ファイルのメタデータを再取得
- ✅ アルバムアートの表示
- ✅ ファイル変更時の自動更新

---

## 使用例

### シナリオ1: プレイリストを作成して曲を追加

1. サイドバーの「+」ボタンをクリック
2. 「お気に入りの曲」と入力して作成
3. 曲リストから好きな曲の「...」メニューをクリック
4. 「プレイリストに追加」→「お気に入りの曲」を選択
5. サイドバーの「お気に入りの曲」をクリックして確認

### シナリオ2: バックグラウンド再生

1. 曲を再生
2. ブラウザを最小化
3. スマートフォンのロック画面から操作
4. 「次の曲」ボタンで次の曲へ移動
5. 「一時停止」ボタンで停止

### シナリオ3: 既存ファイルのメタデータ更新

1. ホーム画面の「ライブラリをスキャン」ボタンをクリック
2. スキャンが完了するまで待つ
3. 曲リストで正しいメタデータが表示されることを確認

---

## トラブルシューティング

### Media Session APIが動作しない

**原因**: ブラウザが対応していない、またはHTTPS接続が必要

**解決方法**:
- Chrome/Edgeの最新版を使用
- HTTPS接続で開く（localhost は HTTP でも動作）

### プレイリストに曲が追加できない

**原因**: データベースエラー、または既に追加済み

**解決方法**:
- ブラウザのコンソールでエラーを確認
- 既に追加されている場合は重複追加できません

### 前の曲/次の曲ボタンが動作しない

**原因**: プレイリストが設定されていない

**解決方法**:
- 曲リストから曲を選択して再生
- プレイリストから曲を再生

---

## 技術仕様

### Media Session API

```typescript
// メタデータの設定
navigator.mediaSession.metadata = new MediaMetadata({
  title: '曲名',
  artist: 'アーティスト名',
  album: 'アルバム名',
  artwork: [{ src: 'アートワークURL', sizes: '512x512' }]
});

// アクションハンドラーの設定
navigator.mediaSession.setActionHandler('play', () => {
  // 再生処理
});

navigator.mediaSession.setActionHandler('pause', () => {
  // 一時停止処理
});

navigator.mediaSession.setActionHandler('previoustrack', () => {
  // 前の曲へ
});

navigator.mediaSession.setActionHandler('nexttrack', () => {
  // 次の曲へ
});
```

### Zustand Store

```typescript
interface MusicStore {
  currentPlaylist: Track[];
  playNext: () => void;
  playPrevious: () => void;
  setCurrentPlaylist: (playlist: Track[]) => void;
}
```

### API エンドポイント

- `POST /api/playlists` - プレイリスト作成
- `GET /api/playlists` - プレイリスト一覧取得
- `GET /api/playlists/[id]` - プレイリスト詳細取得
- `DELETE /api/playlists/[id]` - プレイリスト削除
- `POST /api/playlists/[id]/tracks` - プレイリストに曲を追加
- `DELETE /api/playlists/[id]/tracks` - プレイリストから曲を削除

---

## 今後の拡張案

### 実装予定の機能

1. **シャッフル再生**
   - プレイリスト内でランダムに再生

2. **リピート再生**
   - 1曲リピート
   - プレイリストリピート

3. **プレイリストの並び替え**
   - ドラッグ&ドロップで曲順を変更

4. **プレイリストのエクスポート/インポート**
   - M3U形式でエクスポート
   - 他のプレイヤーからインポート

5. **スマートプレイリスト**
   - 条件に基づいて自動生成
   - ジャンル、アーティスト、年代などでフィルター

6. **プレイリストの共有**
   - URLで共有
   - QRコードで共有

---

## まとめ

このアプリケーションは、以下の主要機能を実装しています：

✅ **バックグラウンド再生**: ロック画面から操作可能
✅ **プレイリスト管理**: 自由に作成・削除・編集
✅ **前後の曲移動**: スムーズな曲送り
✅ **メタデータ管理**: 正確な曲情報表示
✅ **レスポンシブデザイン**: モバイルでも快適

すべての機能が統合され、シームレスな音楽体験を提供します。

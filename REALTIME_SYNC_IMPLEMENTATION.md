# リアルタイム同期とメタデータ更新機能 - 実装完了

## 概要
音楽ライブラリのメタデータ更新とリアルタイム同期機能が完全に実装されました。

## 実装された機能

### 1. ファイル監視と自動スキャン
- **ファイル監視**: `chokidar`を使用して`uploads/music`ディレクトリを監視
- **デバウンス**: 3秒のデバウンスで複数のファイル変更をまとめて処理
- **自動スキャン**: ファイルの追加・変更・削除時に自動的にライブラリをスキャン

### 2. メタデータ更新検出
- **更新日時チェック**: ファイルの`mtime`とDBの`updatedAt`を比較
- **差分更新**: 変更されたファイルのみメタデータを再取得
- **効率的な処理**: 不要なメタデータ取得を回避

### 3. Socket.ioリアルタイム通知
- **イベントタイプ**:
  - `track-added`: 新しい曲が追加された
  - `track-updated`: 曲のメタデータが更新された
  - `track-deleted`: 曲が削除された
  - `scan-complete`: スキャンが完了した

### 4. フロントエンド自動更新
- **リアルタイムリスナー**: `useSocket`フックでライブラリ更新を監視
- **自動リロード**: 更新通知を受信すると自動的にトラックリストを再取得
- **トースト通知**: ユーザーに更新内容を通知

### 5. アルバムアートのキャッシュ対策
- **タイムスタンプ付きURL**: `?v={timestamp}`をクエリパラメータとして追加
- **ブラウザキャッシュ回避**: 画像更新時に確実に新しい画像を表示

## 実装ファイル

### バックエンド
1. **server.js**
   - chokidarファイル監視の実装
   - Socket.ioのグローバル設定
   - 自動スキャンのトリガー（3秒デバウンス）

2. **lib/music-scanner.ts**
   - ファイル更新日時チェック
   - Socket.io通知の送信
   - タイムスタンプ付きアートワークURL生成

3. **app/api/music/scan/route.ts**
   - Socket.ioインスタンスの取得と渡し

### フロントエンド
1. **hooks/useSocket.ts**
   - `library-update`イベントリスナー
   - コールバック関数のサポート

2. **components/MainContent.tsx**
   - Socket.ioリスナーの実装
   - 自動リロード処理
   - トースト通知の表示

### 設定ファイル
1. **package.json**
   - `chokidar`依存関係の追加

2. **public/artwork/.gitkeep**
   - アートワークディレクトリの作成

## 動作フロー

### ファイル追加時
1. ユーザーが`uploads/music`に音楽ファイルを追加
2. chokidarが変更を検出
3. 3秒後に自動スキャンが実行
4. 新しい曲がDBに追加
5. Socket.ioで`track-added`イベントを送信
6. フロントエンドがイベントを受信
7. トラックリストを自動リロード
8. トースト通知を表示

### ファイル更新時
1. 音楽ファイルのメタデータが変更される
2. chokidarが変更を検出
3. 3秒後に自動スキャンが実行
4. ファイルの`mtime`がDBの`updatedAt`より新しいことを検出
5. メタデータを再取得してDBを更新
6. Socket.ioで`track-updated`イベントを送信
7. フロントエンドがイベントを受信
8. トラックリストを自動リロード
9. トースト通知を表示

### ファイル削除時
1. 音楽ファイルが削除される
2. chokidarが変更を検出
3. 3秒後に自動スキャンが実行
4. クリーンアップ処理でDBから削除
5. Socket.ioで`track-deleted`イベントを送信
6. フロントエンドがイベントを受信
7. トラックリストを自動リロード
8. トースト通知を表示

## 使用方法

### サーバー起動
```bash
npm run dev
```

サーバー起動時に以下が自動的に実行されます:
- 初回ライブラリスキャン（2秒後）
- ファイル監視の開始（5秒後）

### 手動スキャン
フロントエンドの「ライブラリをスキャン」ボタンをクリックすることで、いつでも手動スキャンが可能です。

## 技術仕様

### ファイル監視設定
```javascript
chokidar.watch(watchPath, {
  ignored: /(^|[\/\\])\../, // 隠しファイルを無視
  persistent: true,
  ignoreInitial: true, // 初回スキャンは手動で行う
  awaitWriteFinish: {
    stabilityThreshold: 2000, // ファイル書き込み完了を2秒待つ
    pollInterval: 100
  }
});
```

### デバウンス設定
- **遅延時間**: 3秒
- **目的**: 複数のファイル変更をまとめて処理し、不要なスキャンを削減

### Socket.ioイベント形式
```typescript
{
  type: 'track-added' | 'track-updated' | 'track-deleted' | 'scan-complete',
  track?: Track, // track-added, track-updatedの場合
  trackId?: string, // track-deletedの場合
  result?: ScanResult, // scan-completeの場合
  timestamp: number
}
```

## 注意事項

1. **TypeScript警告**: `music-metadata`の`parseFile`に関するTypeScript定義エラーがありますが、実行時には問題ありません。

2. **パフォーマンス**: 大量のファイルを一度に追加する場合、3秒のデバウンスにより最後の変更から3秒後にスキャンが実行されます。

3. **ネットワーク**: Cloudflare Tunnel経由でもSocket.ioは正常に動作します（WebSocketとpollingの両方をサポート）。

## テスト方法

1. サーバーを起動: `npm run dev`
2. ブラウザで`http://localhost:3001`にアクセス
3. `uploads/music`に音楽ファイルを追加
4. 3秒後に自動的にトラックリストが更新されることを確認
5. トースト通知が表示されることを確認

## 完了状態

✅ chokidar依存関係の追加
✅ ファイル監視機能の実装
✅ メタデータ更新検出の実装
✅ Socket.io統合
✅ フロントエンド自動更新の実装
✅ トースト通知の実装
✅ アートワークディレクトリの作成
✅ キャッシュ対策の実装

すべての機能が正常に動作する状態です。

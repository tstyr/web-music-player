# デバイス同期テストガイド

## 🚀 クイックスタート（5分）

### ステップ1: サーバー起動

```bash
# Windowsの場合
start.bat

# Mac/Linuxの場合
./start.sh
```

サーバーが起動したら、以下のメッセージが表示されます：
```
========================================
  🎵 Music Player Server Started
========================================
  Local:    http://localhost:3000
  Network:  http://0.0.0.0:3000
========================================
```

### ステップ2: PCでアクセス

1. ブラウザで `http://localhost:3000` を開く
2. F12でコンソールを開く
3. 以下のログを確認：
```
[Socket] Connected: abc123
[Socket] Device registered: {deviceId: "abc123", deviceName: "Windows PC", deviceType: "desktop"}
[Socket] Device list updated: [{id: "abc123", name: "Windows PC", ...}]
```

### ステップ3: スマホでアクセス

#### 方法1: ローカルネットワーク

1. PCのIPアドレスを確認
```bash
# Windowsの場合
ipconfig

# Mac/Linuxの場合
ifconfig
```

2. スマホのブラウザで `http://[PCのIPアドレス]:3000` を開く
   - 例: `http://192.168.1.100:3000`

3. スマホのコンソールを確認（Safariの場合）
   - 設定 → Safari → 詳細 → Webインスペクタ
   - Macで Safari → 開発 → [デバイス名]

#### 方法2: Cloudflare Tunnel

```bash
# Cloudflare Tunnelで起動
start-with-tunnel.bat

# 表示されたURLをスマホで開く
# 例: https://abc-def-ghi.trycloudflare.com
```

### ステップ4: デバイスリストを確認

1. PCまたはスマホで画面右下のスピーカーアイコンをクリック
2. 「デバイスを選択」ポップアップが開く
3. 接続中のデバイスが表示されることを確認

**期待される表示**:
```
デバイスを選択
🟢 2台接続中

📱 iPhone (このデバイス)
   接続中

💻 Windows PC
   接続中
```

### ステップ5: 同期再生をテスト

1. 両方のデバイスで「全デバイスで同時再生」をON
2. PCでプレイリストを再生
3. スマホでも自動的に再生が始まることを確認
4. プログレスバーが同期していることを確認

---

## 📊 詳細テストシナリオ

### シナリオ1: 基本的なデバイス検出

**目的**: デバイスが正しく検出されるか確認

**手順**:
1. PCでアクセス → デバイスリストに「Windows PC」が表示
2. スマホでアクセス → デバイスリストに「iPhone」または「Android Device」が追加
3. タブレットでアクセス → デバイスリストに「iPad」または「Tablet」が追加

**期待結果**:
- [ ] 各デバイスが自動的に検出される
- [ ] デバイス名が正しく判別される
- [ ] 接続数が正しく表示される（例: 3台接続中）
- [ ] リアルタイムで更新される

### シナリオ2: デバイスの切断と再接続

**目的**: デバイスの切断が正しく処理されるか確認

**手順**:
1. 3台のデバイスを接続
2. スマホのブラウザを閉じる
3. PCのデバイスリストを確認
4. スマホで再度アクセス

**期待結果**:
- [ ] スマホを閉じると「2台接続中」に減る
- [ ] デバイスリストからスマホが消える
- [ ] 再接続すると「3台接続中」に戻る
- [ ] デバイスリストにスマホが再表示される

### シナリオ3: 同期再生の精度

**目的**: 同期精度が50ms以内か確認

**手順**:
1. 2台のデバイスで同期モードをON
2. デバイスAで再生開始
3. 両方のデバイスのコンソールを確認
4. プログレスバーの位置を目視確認

**期待結果**:
- [ ] 両方のデバイスで同時に再生開始
- [ ] コンソールに `[Sync Play] Scheduled in XXms` が表示
- [ ] プログレスバーが完全に同期
- [ ] ドリフト補正が30ms以内

**コンソールログ例**:
```
デバイスA:
[Sync Play] Scheduled in 145ms (server offset: 5.23ms)

デバイスB:
[Sync Play] Scheduled in 146ms (server offset: 4.87ms)
```

### シナリオ4: 次の曲への同期切り替え

**目的**: トラック切り替えが同期するか確認

**手順**:
1. 2台のデバイスで同期モードをON
2. 短い曲を再生
3. 曲が終わるまで待つ
4. 次の曲への切り替えを確認

**期待結果**:
- [ ] 両方のデバイスで同時に次の曲に切り替わる
- [ ] 切り替え時のギャップがない
- [ ] プログレスバーがリセットされる

### シナリオ5: 一時停止/再開の同期

**目的**: 一時停止と再開が同期するか確認

**手順**:
1. 2台のデバイスで同期モードをON
2. デバイスAで再生中
3. デバイスBで一時停止ボタンをクリック
4. デバイスAで再生ボタンをクリック

**期待結果**:
- [ ] デバイスBで一時停止すると、デバイスAも一時停止
- [ ] デバイスAで再生すると、デバイスBも再生再開
- [ ] 再開後も同期が維持される

### シナリオ6: シークの同期

**目的**: シーク操作が同期するか確認

**手順**:
1. 2台のデバイスで同期モードをON
2. デバイスAで再生中
3. デバイスBでプログレスバーをドラッグ
4. デバイスAの再生位置を確認

**期待結果**:
- [ ] デバイスBでシークすると、デバイスAも同じ位置にシーク
- [ ] シーク後も同期が維持される
- [ ] プログレスバーが同期している

---

## 🔍 トラブルシューティング

### 問題1: デバイスが表示されない

**症状**: 「デバイスを選択」に他のデバイスが表示されない

**確認項目**:

1. **Socket.io接続を確認**
```javascript
// ブラウザコンソールで確認
[Socket] Connected: abc123  // ← これが表示されるか？
```

2. **サーバーログを確認**
```
[Socket.io] Client connected: abc123 (IP: 192.168.1.100, Type: mobile)
[Socket.io] Broadcasting device list: 2 devices
```

3. **ネットワーク設定を確認**
- 同じWi-Fiネットワークに接続しているか
- ファイアウォールがポート3000を許可しているか
- プライベートネットワークモードになっているか

**解決方法**:

```bash
# Windowsファイアウォールの設定
1. コントロールパネル → システムとセキュリティ → Windows Defender ファイアウォール
2. 詳細設定 → 受信の規則 → 新しい規則
3. ポート → TCP → 特定のローカルポート: 3000
4. 接続を許可する → プライベート、パブリック
5. 名前: Node.js Music Server
```

### 問題2: 同期がズレる

**症状**: デバイス間で再生位置がズレる

**確認項目**:

1. **時刻同期を確認**
```javascript
// コンソールで確認
[Time Sync] Offset: 5.23ms (RTT: 12.45ms)
```

2. **ドリフト補正を確認**
```javascript
[Sync] Drift detected: 52ms, correcting...
```

**解決方法**:

```typescript
// 遅延パラメータを増やす
// hooks/useSocket.ts
requestSyncPlay(trackId, 0, 200); // 150ms → 200ms

// 同期チェック頻度を下げる
// components/SyncPlaybackController.tsx
if (now - lastSyncTimeRef.current > 100) { // 50ms → 100ms
```

### 問題3: 音が途切れる

**症状**: 再生中に音が途切れる

**原因**:
- ネットワーク帯域不足
- 同期チェックが頻繁すぎる
- バッファサイズが小さい

**解決方法**:

```typescript
// 同期チェック頻度を下げる
if (now - lastSyncTimeRef.current > 100) { // 50ms → 100ms

// 補正閾値を上げる
if (drift > 0.05) { // 30ms → 50ms
```

### 問題4: Cloudflare Tunnel経由で接続できない

**症状**: Tunnelで起動したURLにアクセスできない

**確認項目**:

1. **Tunnelが起動しているか確認**
```bash
# start-with-tunnel.bat の出力を確認
Your quick Tunnel has been created! Visit it at:
https://abc-def-ghi.trycloudflare.com
```

2. **CORS設定を確認**
```javascript
// server.js
cors: {
  origin: '*',  // ← これが設定されているか
  methods: ['GET', 'POST'],
  credentials: true
}
```

**解決方法**:

```bash
# Tunnelを再起動
Ctrl+C で停止
start-with-tunnel.bat で再起動
```

---

## 📈 パフォーマンス測定

### 同期精度の測定

```javascript
// ブラウザコンソールで実行
let drifts = [];
setInterval(() => {
  const audio = document.querySelector('audio');
  if (audio && audio.currentTime > 0) {
    console.log(`Current time: ${audio.currentTime.toFixed(3)}s`);
  }
}, 100);

// 複数デバイスで同時に実行し、時刻を比較
```

### ネットワーク遅延の測定

```javascript
// コンソールで確認
[Time Sync] Offset: 5.23ms (RTT: 12.45ms)
                              ↑
                         往復遅延時間
```

**目標値**:
- RTT: 50ms以下
- Offset: ±10ms以内
- Drift: 30ms以下

---

## ✅ テスト完了チェックリスト

### 基本機能
- [ ] PCでアクセスできる
- [ ] スマホでアクセスできる
- [ ] デバイスリストに表示される
- [ ] デバイス名が正しく判別される
- [ ] 接続数が正しく表示される

### 同期機能
- [ ] 同期モードをONにできる
- [ ] 再生が同期する
- [ ] 一時停止が同期する
- [ ] シークが同期する
- [ ] 次の曲への切り替えが同期する

### パフォーマンス
- [ ] 同期精度が50ms以内
- [ ] 音が途切れない
- [ ] プログレスバーが滑らか
- [ ] UIが反応的

### ネットワーク
- [ ] ローカルネットワークで動作
- [ ] Cloudflare Tunnel経由で動作
- [ ] 複数デバイスで同時接続
- [ ] デバイスの切断/再接続が正常

---

## 🎉 成功の確認

全てのテストが完了したら、以下を確認してください：

1. **デバイスリスト**: 全てのデバイスが表示される
2. **同期精度**: ±50ms以内
3. **安定性**: 長時間再生してもズレない
4. **ユーザー体験**: Spotifyのような快適な操作感

**おめでとうございます！デバイス間同期が完全に動作しています！** 🎵✨
